<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003" >
  <UsingTask TaskName="GetRuntimeDependencies" TaskFactory="CodeTaskFactory" AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.v4.0.dll">
    <ParameterGroup>
      <DependencyPattern ParameterType="System.String" Required="true" />
      <CudaCompile ParameterType="Microsoft.Build.Framework.ITaskItem[]" Required="true" />
      <RuntimeDependencies ParameterType="Microsoft.Build.Framework.ITaskItem[]" Output="true" />
    </ParameterGroup>
    <Task>
      <Using Namespace="System" />
      <Using Namespace="System.Collections.Generic" />
      <Using Namespace="System.Linq" />
      <Code Type="Fragment" Language="cs">
        <![CDATA[
var itemAsName = "cpu";
var item = CudaCompile.Select(x=>x.GetMetadata("CodeGeneration")).FirstOrDefault();
if (item != null) {
  if (item.IndexOf("11") != -1) itemAsName = "11";
  if (item.IndexOf("20") != -1) itemAsName = "20";
  if (item.IndexOf("30") != -1) itemAsName = "30";
  if (item.IndexOf("35") != -1) itemAsName = "35";
}
RuntimeDependencies = new TaskItem[] { new TaskItem(string.Format(DependencyPattern, itemAsName)) };
]]>
      </Code>
    </Task>
  </UsingTask>

  <ItemDefinitionGroup>
    <ClCompile>
      <PreprocessorDefinitions Condition="'%(RuntimeDependencies)'!='Runtime.cpu.lib'">_GPU;%(PreprocessorDefinitions)</PreprocessorDefinitions>
      <PreprocessorDefinitions Condition="'$(LD)'=='V'">_VISUAL;%(PreprocessorDefinitions)</PreprocessorDefinitions>
      <AdditionalIncludeDirectories>$(MSBuildThisFileDirectory)include;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
      <PreprocessorDefinitions>HASRUNTIME;%(PreprocessorDefinitions)</PreprocessorDefinitions>
    </ClCompile>
    <Link>
      <AdditionalDependencies>$(RuntimeDependencies);%(AdditionalDependencies)</AdditionalDependencies>
      <AdditionalLibraryDirectories>$(MSBuildThisFileDirectory)lib\$(Platform).$(Configuration);%(AdditionalLibraryDirectories)</AdditionalLibraryDirectories>
    </Link>
    <CudaCompile>
      <GenerateRelocatableDeviceCode>true</GenerateRelocatableDeviceCode>
    </CudaCompile>
  </ItemDefinitionGroup>
  <Target Name="BeforeBuild">
    <GetRuntimeDependencies DependencyPattern="Runtime.{0}.lib" CudaCompile="@(CudaCompile)">
      <Output TaskParameter="RuntimeDependencies" ItemName="RuntimeDependencies" />
    </GetRuntimeDependencies>
    <Message Condition="'@(RuntimeDependencies)'=='Runtime.cpu.lib'" Importance="High" Text="WIN" />
    <Message Importance="High" Text="B: '@(RuntimeDependencies)'" />
  </Target>
</Project>